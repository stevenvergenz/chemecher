#include "iomanager.h"

IOManager *iomgr = new IOManager();

IOManager::IOManager()
{}

bool IOManager::saveToCM3(QString sim, QString mech)
{
	/***************** write to the mechanism file *****************/
	
	//open the mechanism file
	QFile mfile(mech);
	if( !mfile.open( QFile::WriteOnly ) ){
		status = FS_ERROR;
		message = "Error opening file "+mech;
		return false;
	}

	//print header
	QTextStream mOut( &mfile );
	mOut << "'Generated by CheMecher v4 on ";
	mOut << QDateTime::currentDateTime().toString("ddd MMMM d yyyy hh:mm ap") << endl;
	mOut << "'Created in conjunction with simulation: "+QFileInfo(sim).fileName() << endl;
	mOut << "'Name: " + (mix->mechName.isEmpty() ? "<empty>" : mix->mechName) << endl;
	mOut << "'Desc: " + (mix->mechDesc.isEmpty() ? "<empty>" : mix->mechDesc) << endl;
	mOut << endl;
	
	//write out the cpd list
	mOut << "'compound list" << endl;
	mOut << mix->CpdList.size() << " 'number of compounds" << endl;
	for(int i=0; i<mix->CpdList.size(); i++)
		mOut << mix->CpdList[i]->tov3String() << endl;
	mOut << endl;

	//write out the step list
	mOut << "'step list" << endl;
	mOut << mix->StepList.size() << " 'number of steps" << endl;
	for(int i=0; i<mix->StepList.size(); i++)
		mOut << mix->StepList[i]->tov3String() << endl;
	mOut << endl;

	mfile.close();

	/****************** write to the simulation file *****************/

	//open the simulation file
	QFile sfile(sim);
	if( !sfile.open( QFile::WriteOnly ) ){
		status = FS_ERROR;
		message = "Error opening file "+sim;
		return false;
	}

	//print header
	QTextStream sOut( &sfile );
	sOut << "'Generated by CheMecher v4 on ";
	sOut << QDateTime::currentDateTime().toString("ddd MMMM d yyyy hh:mm ap") << endl;
	sOut << "'Created in conjunction with mechanism: "+QFileInfo(mech).fileName() << endl;
	sOut << endl;

	//output parameters
	sOut << "calcstep=" << mix->timeStep << endl;
	sOut << "reportstep=" << mix->reportStep << endl;
	sOut << "maxtime=" << mix->endTime-mix->startTime
		<< "   'from "<<mix->startTime<<" to "<<mix->endTime << endl;
	sOut << "order=" << mix->order << endl;
	sOut << "method=" << mix->method << endl;
	sOut << "transition=" << mix->transition << endl;
	sOut << endl;
	sOut << "autostep=" << (mix->autostep ? "yes" : "no") << endl;
	sOut << "gateband=" << (mix->autostep ? QString::number(mix->gateband) : "0") << endl;
	sOut << "shifttest=" << (mix->autostep ? QString::number(mix->shifttest) : "0") << endl;
	sOut << "maxreduce=" << (mix->autostep ? QString::number(mix->maxreduce) : "0") << endl;
	sOut << "stepfactor=" << (mix->autostep ? QString::number(mix->stepfactor) : "0") << endl;
	sOut << endl;

	//output the initial concentrations
	sOut << "'initial concentrations" << endl;
	sOut << "'any species not listed are assumed to have an initial concentration of zero" << endl;
	for(int i=0; i<mix->CpdList.size(); i++)
		sOut << mix->CpdList[i]->toString()
		<< QString().fill(' ',mix->maxCpdIdLen()+1-mix->CpdList[i]->toString().length())
		<< mix->CpdList[i]->initialConc() << endl;

	//done writing, close file
	sfile.close();

	return true;
}

// function declaration
QString getLine(QTextStream&,int &);

bool IOManager::loadFromCM3(QString sim, QString mech)
{
	Mix newmix;
	QFile sfile(sim), mfile(mech);

	/********************* start parsing the mech file ********************/

	//open the mech file
	if( !mfile.open( QFile::WriteOnly ) ){
		status = FS_ERROR;
		message = "Error opening file "+mech;
		return false;
	}

	//start reading
	QTextStream min(&mfile);
	int linecounter = 0;
	QString buffer;
	bool ok = true;

	//read the number of species
	buffer = getLine( min, linecounter );
	int numspecies = buffer.toInt(&ok, 10);
	if( !ok || numspecies<1){
		status = PARSE_ERROR;
		message = "Error line "+QString::number(linecounter)+": positive integer expected";
		return false;
	}

	//read the species
	for(int i=0; i<numspecies; i++)
	{

	}

	return true;
}

// gets the next line of valid input
QString getLine(QTextStream& txt, int &linecounter)
{
	QString ret = "";
	while( ret=="" && !txt.atEnd() ) {
		ret = txt.readLine();
		ret = ret.left( ret.indexOf("'") ).simplified();
		linecounter++;
	}
	return ret;
}

bool IOManager::saveToCM4(QString filename)
{
	
	return false;
}

bool IOManager::loadFromCM4(QString filename)
{
	
	return false;
}

